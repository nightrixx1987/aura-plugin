name: Build macOS

on:
  workflow_dispatch:  # Manuell auslösbar über GitHub UI
  push:
    tags:
      - 'v*'         # Automatisch bei Version-Tags (v1.0.0, v1.1.0, etc.)

jobs:
  build-macos:
    runs-on: macos-14  # Apple Silicon Runner (M1)
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
      
      - name: Verify Submodules
        run: |
          echo "=== Submodule Status ==="
          git submodule status --recursive
          echo ""
          echo "=== JUCE vorhanden ==="
          ls JUCE/CMakeLists.txt
          echo "=== clap-juce-extensions ==="
          ls clap-juce-extensions/CMakeLists.txt || echo "CLAP nicht vorhanden (optional)"
      
      - name: Configure CMake (Universal Binary)
        run: |
          cmake -B build \
            -G Xcode \
            -DCMAKE_OSX_ARCHITECTURES="arm64;x86_64" \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=10.15 \
            -DAURA_ENABLE_LTO=ON
      
      - name: Build
        run: |
          cmake --build build --config Release --target Aura_All -- -parallelizeTargets -jobs $(sysctl -n hw.ncpu)
      
      - name: Verify Build
        run: |
          echo "=== Build Artefakte ==="
          find build/Aura_artefacts -name "*.vst3" -o -name "*.app" -o -name "*.clap" | head -20
          echo ""
          echo "=== VST3 Bundle ==="
          ls -la build/Aura_artefacts/Release/VST3/Aura.vst3/Contents/MacOS/ || ls -la build/Aura_artefacts/VST3/Aura.vst3/Contents/MacOS/
          echo ""
          echo "=== Standalone ==="
          ls -la build/Aura_artefacts/Release/Standalone/Aura.app/Contents/MacOS/ || ls -la build/Aura_artefacts/Standalone/Aura.app/Contents/MacOS/
          echo ""
          echo "=== Architecture Check ==="
          file build/Aura_artefacts/Release/VST3/Aura.vst3/Contents/MacOS/Aura || file build/Aura_artefacts/VST3/Aura.vst3/Contents/MacOS/Aura
      
      - name: Create DMG
        run: |
          mkdir -p dmg_contents
          cp -R build/Aura_artefacts/Release/VST3/Aura.vst3 dmg_contents/
          cp -R build/Aura_artefacts/Release/Standalone/Aura.app dmg_contents/
          
          # Installationsanweisungen
          cat > dmg_contents/README.txt << 'EOF'
          Aura - Installation
          ====================
          
          VST3:
            Kopiere "Aura.vst3" nach:
            /Library/Audio/Plug-Ins/VST3/
          
          Standalone:
            Kopiere "Aura.app" nach:
            /Applications/
          EOF
          
          hdiutil create -volname "Aura" \
            -srcfolder dmg_contents \
            -ov -format UDZO \
            "Aura-macOS-universal.dmg"
      
      - name: Test DMG
        run: |
          echo "=== DMG mounten ==="
          hdiutil attach Aura-macOS-universal.dmg -noverify -nobrowse
          MOUNT_POINT=$(hdiutil info | grep "/Volumes/Aura" | awk '{print $NF}')
          echo "Gemountet: $MOUNT_POINT"
          
          echo ""
          echo "=== DMG Inhalt ==="
          ls -la "$MOUNT_POINT/"
          
          echo ""
          echo "=== VST3 vorhanden ==="
          ls -la "$MOUNT_POINT/Aura.vst3/Contents/MacOS/"
          file "$MOUNT_POINT/Aura.vst3/Contents/MacOS/Aura"
          
          echo ""
          echo "=== Standalone vorhanden ==="
          ls -la "$MOUNT_POINT/Aura.app/Contents/MacOS/"
          file "$MOUNT_POINT/Aura.app/Contents/MacOS/Aura"
          
          echo ""
          echo "=== Universal Binary Check ==="
          lipo -info "$MOUNT_POINT/Aura.vst3/Contents/MacOS/Aura"
          lipo -info "$MOUNT_POINT/Aura.app/Contents/MacOS/Aura"
          
          echo ""
          echo "=== VST3 Bundle Validierung ==="
          pluginval_ok=true
          test -f "$MOUNT_POINT/Aura.vst3/Contents/MacOS/Aura" || pluginval_ok=false
          test -f "$MOUNT_POINT/Aura.vst3/Contents/Info.plist" || echo "WARNUNG: Info.plist fehlt"
          
          echo ""
          echo "=== Standalone Quick Launch Test ==="
          timeout 5 "$MOUNT_POINT/Aura.app/Contents/MacOS/Aura" --help 2>&1 || echo "(Timeout/Exit erwartet - Plugin braucht Audio Device)"
          
          echo ""
          echo "=== DMG unmounten ==="
          hdiutil detach "$MOUNT_POINT"
          echo "DMG TEST BESTANDEN"
      
      - name: Upload VST3
        uses: actions/upload-artifact@v4
        with:
          name: Aura-macOS-VST3
          path: build/Aura_artefacts/Release/VST3/Aura.vst3
          retention-days: 90
      
      - name: Upload Standalone
        uses: actions/upload-artifact@v4
        with:
          name: Aura-macOS-Standalone
          path: build/Aura_artefacts/Release/Standalone/Aura.app
          retention-days: 90

      - name: Upload DMG
        uses: actions/upload-artifact@v4
        with:
          name: Aura-macOS-DMG
          path: Aura-macOS-universal.dmg
          retention-days: 90
      
      - name: Create Release (on tag push)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: Aura-macOS-universal.dmg
          generate_release_notes: true
